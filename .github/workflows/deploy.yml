# .github/workflows/deploy.yml
name: Deploy to Render + Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # Detect what changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Backend Tests
  test-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run backend tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
        run: npm test
      
      - name: Run linter
        working-directory: ./backend
        run: npm run lint || echo "Linting completed with warnings"

  # Frontend Tests
  test-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test
      
      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.RENDER_BACKEND_URL }}
        run: npm run build

  # Deploy Backend to Render
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-backend]
    if: |
      always() &&
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.backend == 'true' || needs.test-backend.result == 'skipped')
    environment:
      name: production-backend
      url: ${{ secrets.RENDER_BACKEND_URL }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Trigger Render Deploy (Backend)
        run: |
          echo "üöÄ Triggering Render deployment..."
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}")
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 201 ]; then
            echo "‚úÖ Deployment triggered successfully"
          else
            echo "‚ö†Ô∏è Deployment trigger returned code: $RESPONSE"
            cat response.txt
          fi
      
      - name: Wait for Render deployment
        run: |
          echo "‚è≥ Waiting for Render deployment to complete..."
          sleep 45
          
          # Health check with retries
          MAX_ATTEMPTS=24
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking backend health..."
            
            if curl -f -s --max-time 10 "${{ secrets.RENDER_BACKEND_URL }}/health" > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy and responding!"
              curl -s "${{ secrets.RENDER_BACKEND_URL }}/health" | jq '.' || true
              exit 0
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ Backend not ready yet, waiting 15 seconds..."
              sleep 15
            fi
          done
          
          echo "‚ö†Ô∏è Health check timeout - but deployment may still be in progress"
          echo "Check Render dashboard: https://dashboard.render.com"

  # Deploy Frontend to Vercel
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-frontend, deploy-backend]
    if: |
      always() &&
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.frontend == 'true' || needs.test-frontend.result == 'skipped')
    environment:
      name: production-frontend
      url: https://seyali-test.vercel.app
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        working-directory: ./frontend
        run: |
          npm install -g vercel@latest
          
          echo "üöÄ Deploying to Vercel..."
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} || true
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          
          echo "‚úÖ Frontend deployed successfully!"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Preview Deployments for PRs
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy Preview to Vercel
        working-directory: ./frontend
        run: |
          npm install -g vercel@latest
          
          PREVIEW_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -o 'https://[^ ]*')
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
          echo "‚úÖ Preview deployed: $PREVIEW_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: Comment PR with preview URL
        uses: actions/github-script@v6
        if: env.PREVIEW_URL != ''
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ Preview Deployment Ready!\n\n‚ú® **Frontend Preview:** ${process.env.PREVIEW_URL}\nüîó **Backend:** ${{ secrets.RENDER_BACKEND_URL }}\n\n*This preview will be available until the PR is closed.*`
            })

  # Notification
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary:"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
          else
            echo "‚ö†Ô∏è Some deployments had issues"
          fi